void mqtt_loop()
{
    if (got_mqtt_data)
    {
        send_to_mqtt();
        return;
    }

    if ((unsigned long)(millis() - last_heartbeat) > heartbeat_period)
    {
        last_heartbeat = millis();
        client.publish(MQTT_HB_TOPIC, panel_connected ? "C" : "nc", false, 0);
    }
}

//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////

void mqtt_setup()
{
    client.begin(MQTT_HOST, MQTT_PORT, net);
    client.setWill(MQTT_WILL_TOPIC, "0", true, 0);
    client.onMessage(messageReceived);
    mqtt_connect();
}

//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////

void mqtt_connect()
{
    uint8_t i = 0;

    while (WiFi.status() != WL_CONNECTED)
    {
        delay(100);
        i++;
        if (i > 200)
            ESP.restart();
    }

    // certificare
    BearSSL::X509List cert(digicert);
    net.setTrustAnchors(&cert);

    while (!client.connect(HOSTNAME, MQTT_USER, MQTT_PASS))
    {
        delay(100);
        i++;
        if (i > 200)
            ESP.restart();
    }

    client.subscribe(MQTT_SUB_TOPIC, 0);
    client.publish(MQTT_WILL_TOPIC, "1", true, 0);
}

//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////

void messageReceived(String &topic, String &payload)
{
    StaticJsonDocument<256> doc;
    deserializeJson(doc, payload);
    yield();

    command = doc["cmd"];
    subcommand = doc["scmd"];

    if (doc["time"])
    {
        panel_set_date_time = true;
    }

    doc.clear();
}

//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////

void send_to_mqtt()
{
    got_mqtt_data = false;
    client.publish(topic, mesaj, false, 0);
    // client.publish(MQTT_PUB_TOPIC, mesaj, false, 0);
}

//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////

void send_raw_to_mqtt()
{
    uint8_t i = 0;
    mesaj = "";

    for (i = 0; i < paradox_message_length; i++)
    {
        mesaj += String(paradox_rx[i], HEX);
        mesaj += " ";
    }

    client.publish(MQTT_RAW_TOPIC, mesaj, false, 0);
}

//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////

void send_panel_status_to_mqtt()
{
    StaticJsonDocument<1024> doc;

    /*
    if (timer_loss)
        doc["trouble"]["timer"] = "Timer loss";
    if (power_trouble)
        doc["trouble"]["power"] = "Power trouble";
    if (ac_failure)
        doc["trouble"]["ac"] = "AC failure";
    if (low_battery)
        doc["trouble"]["battery"] = "Low battery";
    if (telephone_trouble)
        doc["trouble"]["tel"] = "Telephone trouble";
    doc["acv"] = ac_voltage;
    doc["dcv"] = dc_voltage;
    doc["bat"] = battery_voltage;

    if (fire)
        doc["alarm"] = "Fire";
    if (audible)
        doc["alarm"] = "Audible";
    if (silent)
        doc["alarm"] = "Silent";
    if (alarm)
        doc["alarm"] = "Alarm";
    if (stay)
        doc["alarm"] = "Stay";
    if (sleep)
        doc["alarm"] = "Sleep";
    if (arm)
        doc["alarm"] = "Arm";
*/

    // String mesaj;
    serializeJson(doc, mesaj);
    doc.clear();

    client.publish(MQTT_PANEL_TOPIC, mesaj, false, 0);
}

//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////